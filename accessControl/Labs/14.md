# [Lab: Referer-based access control](https://portswigger.net/web-security/access-control/lab-referer-based-access-control)

**الهدف:** استغلال نظام وصول يعتمد على هدر `Referer` فقط لتخطي القيود ورفع صلاحية مستخدم عادي إلى Administrator.

**بيانات للتعرّف:**

* Admin (للاطلاع على واجهة): `administrator:admin`
* المستخدم الهدف: `wiener:peter`

---

## نظرة عامة

بعض التطبيقات تعتمد على قيمة هدر `Referer` للتحكم في الوصول لواجهات إدارية أو عمليات حسّاسة. هذا خطأ لأن الهدر يتم إرساله من المتصفح ويمكن التلاعب به أو إعادة إرساله (replay) من عميل آخر. الحل الصحيح هو التحقق server-side من صلاحيات الجلسة وعدم الاعتماد على `Referer`.

---

## خطوات الاستغلال (التي قمت بها — مُبسطة ومتسلسلة)

1. **استكشاف الواجهة كـ Admin**

   * سجّلت دخول كـ `administrator` حتى أطلع على شكل طلبات تغيير الصلاحيات ووجود أي فحص يعتمد على `Referer`.
   * شاهدت أن الوصول للوظيفة الحسّاسة (مثلاً: endpoint لتعديل role) يسمح فقط إذا جاء الطلب مع `Referer: https://{target}/admin`.

2. **التقاط الطلب (مع Burp)**

   * أثناء وجودي كـ Admin فعلت عملية تعديل لـ `carlos` (أو مثال آخر) والتقطت الطلبات (Request) والردود (Response) في Burp.
   * لاحظت أن الخادم يفحص هدر `Referer` ويقبل الطلب إذا كان من صفحة الإدارة.

3. **تسجيل الدخول كـ المستخدم المستهدف**

   * سجلت خروج ثم دخلت بحساب `wiener:peter` (المستخدم العادي).
   * التقطت session cookie الخاصة به.

4. **إعادة إرسال الطلب مع تعديل `Referer`**

   * أخذت الطلب الذي يغير الصلاحيات (الذي التقطته أثناء كونك Admin) وأرسلته عبر Repeater/Intruder مع تغييرات:

     * استبدلت Cookie بالجلسة الخاصة بـ `wiener`.
     * ضمنت هدر `Referer` نفس قيمة صفحة الإدارة (مثلاً `Referer: https://<host>/admin`).
   * أرسلت الطلب، ولو أن الجلسة كانت لمستخدم عادي فإن الخادم قبل الطلب لأن الفحص اعتمد على هدر Referer فقط.

5. **التحقق**

   * فتحت حساب `wiener` أو حاولت الدخول إلى لوحة الإدارة وتأكدت أن الصلاحيات ارتفعت إلى Administrator.

---
