# [Password reset poisoning via middleware](https://portswigger.net/web-security/authentication/other-mechanisms/lab-password-reset-poisoning-via-middleware)

> **الهدف**: استغلال ضعف في إعادة تعيين كلمات المرور عن طريق poisoning (تلوّث) وسيط الـ middleware بحيث يرسل رابط إعادة التعيين إلى موقع يتحكم به المهاجم — الضحية (carlos) سيضغط على الرابط ويعيد تعيين كلمة المرور لصالحنا.

---

## 1) ملخص الفكرة 

التطبيق يولّد رابط إعادة تعيين يحتوي توكن (مثلاً `/forgot-password?temp-forgot-password-token=...`) ويرسله عبر البريد. الوسط (middleware) الذي يقوم بتوليد أو إعادة توجيه الروابط يعتمد على قيمة `Host` أو رؤوس HTTP أخرى مثل `X-Forwarded-Host` أو `Forwarded` عند بناء رابط الإيميل، وبالتالي يمكن تزييف هذه الرؤوس لإجبار الرمز أن يشير إلى دومين نتحكّم به (exploit server). إذا ضحية مثل `carlos` يفتح الرابط، نتحكم بالصفحة ونستغل التوكن لتغيير الباسورد.

---

## 2) الخطوات
1. للتجربه علي الحساب الذي امتلكه 
	1. سجِّل دخول بحسابك (wiener:peter) واذهب لصفحة "Forgot password" لطلب إعادة تعيين.
	    
	2. التقط الطلب في Burp Proxy (Intercept) قبل أن يذهب للخادم.
	    
	3. لاحظت أن الإيميل يحتوي على رابط مثل: `https://TARGET/forgot-password?temp-forgot-password-token=...` — لكن الـ Host في الطلب يُستخدم لتوليد الرابط.
	    
	4. غيرت رأس HTTP **X-Forwarded-Host** إلى الدومين الذي أملكه (مثلاً `attacker.com`) أو عنوان الـ exploit server، أو استخدمت `Forwarded: host=attacker.com`/`Host:` في بعض الحالات.
	    ![[photo/Screenshot From 2025-10-26 21-54-21.png]]
	5. أرسلت الطلب، وبدلاً أن يصل رابط إعادة التعيين إلى رابط موقع الهدف، جاء الرابط مشيراً إلى الـ exploit server (الرابط يحتوي نفس التوكن ولكن host مختلف).
	    ![[photo/Screenshot From 2025-10-26 08-58-58.png]]
1. على الـ exploit server جهّزت صفحة تقبل التوكن وتعيد توجيهه أو تعرض رابط يمكنك الضغط عليه — عندما ضغط carlos على الرابط (لأنّه يثق أو يضغط على أي رابط)، صرنا نملك التوكن ونستعمله لتغيير كلمة مرور `carlos` عبر نفس آلية الـ forgot-password (أدخلنا التوكن مع username=carlos وnew-passwords ونفّذنا التغيير).
    
2. سجّلت الدخول إلى حساب `carlos` وبذلك اتحلّ الـ lab.
    

---

## 3) نسخة عملية - مثال Burp 

- في Burp Proxy -> Intercept request قبل أن يرسل السيرفر البريد (أحيانًا التطبيق يتصل بمُرسِل البريد داخل نفس طلب HTTP أو بعده؛ إن استطعت التقط الطلب الذي يولّد الرابط).
    
- أضف رأس جديد أو عدّل الموجود:
    

```
X-Forwarded-Host: attacker-server.com
Forwarded: host=attacker-server.com
Host: original-target (لا تغيره إلا لو متأكد)
```

- أكمِل الطلب وأرسِل.
    

الهدف: أن يجعل الخادم يركّب رابط الإيميل باستخدام قيمة `attacker-server.com` بدلًا من `TARGET`.

---
