![[photo/password-reset-poisoning.svg]]
date: 2025-10-18
### **التفاصيل الكاملة لثغرات المصادقة (Authentication Vulnerabilities)**

#### **1. الفرق الأساسي: المصادقة (Authentication) vs التفويض (Authorization)**
- **المصادقة (Authentication):** "من أنت؟" - عملية إثبات الهوية (مثل: تسجيل الدخول).
- **التفويض (Authorization=access control):** "ماذا يُسمح لك أن تفعل؟" - عملية تحديد الصلاحيات (مثل: هل يمكنك حذف هذا المقال؟).
- **العلاقة:** يجب أن تأتي **المصادقة** أولاً. إذا استطاع المهاجم اختراق المصادقة، يمكنه الوصول إلى مرحلة التفويض واستغلالها.

---

#### **2. التصنيف المتقدم لثغرات المصادقة (كيف نفكر فيها كمختبرين)**

يمكن تقسيمها إلى ثلاث فئات رئيسية:

**أ. ثغرات في آلية الاعتماد (Credential Mechanisms)**
هنا المشكلة في "ما يعرفه المستخدم" (كلمة المرور).

- **ضعف تعقيد كلمة المرور:**
    - **كيفية الاختبار:** محاولة إنشاء حسابات جديدة بكلمات مرور مثل `12345` أو `password` أو حتى حقل فارغ.
    - **الثغرة الأكثر خطورة:** السماح باستخدام **كلمة المرور نفسها كاسم المستخدم**. إذا عرف المهاجم اسم المستخدم، فهو يعرف كلمة المرور!
    - **المنع:** استخدام مكتبات مثل `zxcvbn` (التي ذكرتها) لتقديم تقييم فوري لقوة كلمة المرور.

- **هجمات حشو بيانات الاعتماد (Credential Stuffing):**
    - **السبب:** يستخدم الناس نفس كلمة المرور في أكثر من موقع.
    - **الآلية:** يحصل المهاجم على قائمة من أسماء المستخدمين وكلمات المرور من موقع تم اختراقه (مثل: فيسبوك)، ويجرب نفس هذه البيانات على موقعك (مثل: بنكك).
    - **المنع:** **تفعيل المصادقة متعددة العوامل (MFA)** هو الحل الأقوى. حتى مع سرقة كلمة المرور، لا يستطيع المهاجم الدخول.

**ب. ثغرات في المنطق (Logic Flaws)**
هنا الكود نفسه معيب. هذه أخطر الأنواع لأنها غالباً لا يمكن اكتشافها بالمسح الآلي.

- **تعداد المستخدمين (Username Enumeration):**
    - **الطريقة الكلاسيكية:** رسائل الخطأ المختلفة.
        - "اسم المستخدم غير موجود" vs "كلمة المرور incorrect".
    - **طرق أكثر دهاءً:**
        - **الاختلاف في وقت الاستجابة (Timing Attack):**
            - **المشكلة:** عندما يكون اسم المستخدم صحيحاً، يقوم التطبيق بخطوة إضافية (مثل: جلب بيانات المستخدم من قاعدة البيانات ومقارنة كلمة المرور المشفرة). هذه الخطوة تأخذ بضعة ميلي ثانية إضافية.
            - **كيفية الاستغلال:** يقوم المهاجم بإرسال آلاف الطلبات ويرصد الوقت الذي استغرقه الرد. الطلبات التي استغرقت وقتاً أطول تشير إلى أسماء مستخدمين صحيحة.
            - **المنع:** جعل وقت الاستجابة ثابتاً بغض النظر عن صحة البيانات.
        - **اختلافات دقيقة في الرد (Response Differences):** مثل وجود أو عدم وجود مسافة في نهاية رسالة الخطأ، أو اختلاف في `Status Code` (مثلاً 200 للخطأ في كلمة المرور vs 404 لخطأ في اسم المستخدم).

- **ثغرات المصادقة متعددة المراحل (Multi-Stage Authentication):**
    - **المثال الذي شرحته:** `POST /login2` مع المعامل `verify=carlos` والكوكي `Account=carlos`.
    - **الثغرة:** لم يتم ربط رمز التحقق (`verify`) بجلسة المستخدم (`Account`) بشكل آمن. يمكن للمهاجم استخدام رمز التحقق الخاص بحسابه لاختراق حساب `carlos` بمجرد تغيير قيمة الكوكي.
    - **المنع:** يجب أن يرتبط رمز التحقق بمعرف فريد داخل جلسة المستخدم على الخادم (Session ID) وليس بقيمة يتحكم بها العميل (مثل الكوكي).

- **ثغرات استعادة كلمة المرور:**
    - **الرابط القابل للتخمين:** `https://example.com/reset-password?user_id=12345`.
    - **الرابط الذي لا ينتهي صلاحيته:** يمكن استخدامه مراراً وتكراراً.
    - **أسئلة الأمان الضعيفة:** "ما اسم شارع طفولتك؟" – يمكن اكتشافه عبر وسائل التواصل الاجتماعي (OSINT).
    - **المنع:** إرسال رموز استعادة ذات صلاحية محدودة (10 دقائق) وغير قابلة للتخمين.

**ج. ثغرات في التنفيذ (Implementation Flaws)**
هنا الفكرة صحيحة، ولكن التنفيذ خاطئ.

- **الحماية غير الكافية من الهجمات الغاشمة:**
    - **حظر الحساب (Account Lockout):** جيد، ولكن يمكن استغلاله لهجوم **حرمان الخدمة (DoS)** بحظر جميع حسابات المستخدمين.
    - **الحل الأفضل:** استخدام **معدل التحديد (Rate Limiting)** أو **كابتشا (CAPTCHA)** بعد عدد معين من المحاولات الفاشلة.
    - **الثغرة الشائعة:** تطبيق الحماية على `/login` ولكن نسيان `/login2` (صفحة MFA) أو `/change-password`.

- **التخزين غير الآمن لكلمات المرور:**
    - **مستويات السوء (من الأسوأ للأفضل):**
        1. **نص واضح (Plain Text):** الكلمة محفوظة كما هي. كارثة.
        2. **تشفير (Encryption):** يمكن فكها باستخدام المفتاح. سيء.
        3. **تجزئة (Hashing) بدون إضافة عشوائية (Salt):** `hash(password)`. يمكن كسرها باستخدام **هجمات القاموس (Dictionary Attacks)** أو **جداول قوس قزح (Rainbow Tables)**.
        4. **تجزئة مع إضافة عشوائية (Salted Hash):** `hash(salt + password)`. هذا هو المستوى المقبول. حتى إذا تسربت قاعدة البيانات، يحتاج المهاجم إلى كسر كل كلمة مرور على حدة.
    - **خوارزميات التجزئة الموصى بها:** `bcrypt`, `Argon2`, `PBKDF2`.

---

#### **3. منهجية اختبار المصادقة (خطوة بخطوة)**

1.  **فهم التطبيق (Reconnaissance):**
    - أين توجد جميع نقاط الدخول؟ (`/login`, `/admin`, `/api/auth`).
    - هل هناك وظيفة استعادة كلمة مرور؟ تسجيل مستخدم جديد؟ MFA؟

2.  **اختبار تعداد المستخدمين:**
    - استخدم أدوات مثل **Burp Comparer** أو **Logger++** لمقارنة الردود بدقة.
    - اختبر جميع نقاط الدخول (تسجيل الدخول، استعادة كلمة المرور، التسجيل "هل هذا البريد الإلكتروني مستخدم بالفعل؟").

3.  **اختبار هجمات القوة الغاشمة:**
    - استخدم **Burp Intruder** أو **Hydra**.
    - **تغيير عنوان IP:** إذا كان الحظر يعتمد على IP، استخدم معامل `X-Forwarded-For` في الطلبات أو أدوات تتغير فيها الـ IP تلقائياً.
    - **تخطي الكابتشا:** بعض الكابتشات الضعيفة يمكن حلها آلياً باستخدام OCR.

4.  **تحليل المنطق (Logic Analysis):**
    - **ارسم تدفق المصادقة:** كيف تنتقل من `/login` إلى `/login2` إلى `/dashboard`؟ ما البيانات (`Parameters`, `Cookies`, `Headers`) التي يتم إرسالها في كل خطوة؟
    - **اسأل نفسك:** "ماذا يحدث إذا غيرت هذه القيمة؟" – مثلاً، إذا غيرت `username` إلى `admin` في مرحلة MFA؟
    - **اختبر صلاحية الجلسات:** هل يمكن استخدام جلسة نشطة على متصفح آخر؟ متى تنتهي صلاحيتها؟

5.  **فحص قناة الاتصال:**
    - أجبر الاتصال على استخدام `HTTP` بدلاً من `HTTPS` وشاهد إذا كان التطبيق يسمح بذلك.
    - استخدم **Wireshark** لمراقبة حركة المرور إذا كان الاتصال غير مشفر.

---

#### **4. أمثلة عملية متقدمة من المعامل (Labs)**

- **Lab: 2FA Broken Logic**
    - **الخطوات:**
        1. سجل دخول بحسابك الخاص (`wiener:peter`).
        2. عندما تصل لصفحة إدخال الرمز، **لا تدخله**. بدلاً من ذلك، انقل الطلب `POST /login2` إلى `Burp Repeater`.
        3. في `Repeater`, غير قيمة الكوكي `verify` من `wiener` إلى `carlos`.
        4. أرسل الطلب. الآن، حتى بدون معرفة رمز التحقق الخاص بـ `carlos`، تم ربط جلستك بحسابه.
        5. اذهب إلى `/my-account` وسيتم تحويلك إلى حساب `carlos`.

- **Lab: Offline Password Cracking**
    - **السيناريو:** وجدت أن التطبيق يسجل كافة كلمات المرور الخاطئة في ملف `log` يمكنك الوصول إليه.
    - **الخطوات:**
        1. قم بهجوم قوة غاشمة على حساب `carlos` باستخدام قائمة كلمات مرور شائعة.
        2. ستجد أن جميع المحاولات فشلت، ولكن اذهب إلى ملف `log` (مثل `/var/log/auth.log`).
        3. داخل ملف السجل، ستجد كلمات المرور التي جربتها **مشفرة** (أو مشتقة) لكن باستخدام خوارزمية ضعيفة.
        4. استخدم أداة مثل `John the Ripper` أو `Hashcat` لكسر التجزئة ومعرفة كلمة مرور `carlos` الفعلية.

---

#### **5. أدوات أساسية للاختبار**

- **Burp Suite:** (الإمبراطور)
    - **Proxy:** لاعتراض وفحص الطلبات.
    - **Intruder:** لهجمات القوة الغاشمة وتعداد المستخدمين.
    - **Repeater:** لإعادة إرسال الطلبات وتعديلها يدوياً.
    - **Comparer:** لمقارنة الردود بدقة.
- **OWASP ZAP:** بديل مفتوح المصدر قوي.
- **Wireshark:** لتحليل حركة المرور على مستوى الشبكة.
- **John the Ripper / Hashcat:** لكسر كلمات المرور المشتقة.

---

#### **6. المراجع النهائية للمطورين واختبار الاختراق**

- **OWASP Authentication Cheat Sheet:** دليل مفصل لكيفية تنفيذ المصادقة بشكل آمن.
- **OWASP ASVS (Application Security Verification Standard):**
    - **القسم V2:** هو المعيار الذهبي لمتطلبات أمان المصادقة. استخدمه كقائمة مراجعة (Checklist) أثناء التطوير والاختبار.
- **NIST Digital Identity Guidelines (SP 800-63B):** الإرشادات الرسمية من المعهد الوطني للمعايير والتقنية في أمريكا حول سياسات كلمات المرور والمصادقة.
